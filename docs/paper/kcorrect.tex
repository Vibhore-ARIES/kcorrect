\documentclass[10pt,preprint]{aastex}

\newcommand{\vv}[1]{{\bf #1}}
\newcommand{\df}{\delta}
\newcommand{\dfft}{{\tilde{\delta}}}
\newcommand{\betaft}{{\tilde{\beta}}}
\newcommand{\erf}{{\mathrm{erf}}}
\newcommand{\erfc}{{\mathrm{erfc}}}
\newcommand{\Step}{{\mathrm{Step}}}
\newcommand{\ee}[1]{\times 10^{#1}}
\newcommand{\avg}[1]{{\langle{#1}\rangle}}
\newcommand{\Avg}[1]{{\left\langle{#1}\right\rangle}}
\def\simless{\mathbin{\lower 3pt\hbox
	{$\,\rlap{\raise 5pt\hbox{$\char'074$}}\mathchar"7218\,$}}} % < or of order
\def\simgreat{\mathbin{\lower 3pt\hbox
	{$\,\rlap{\raise 5pt\hbox{$\char'076$}}\mathchar"7218\,$}}} % > or of order
\newcommand{\iras}{{\sl IRAS\/}}
\newcommand{\petroratio}{{{\mathcal{R}}_P}}
\newcommand{\petroradius}{{{r}_P}}
\newcommand{\petronumber}{{{N}_P}}
\newcommand{\petroratiolim}{{{\mathcal{R}}_{P,\mathrm{lim}}}}
\newcommand{\band}[2]{\ensuremath{^{{#1}}\!{#2}}}

\newcommand{\kversion}{{\tt v1\_11}}

\setlength{\footnotesep}{9.6pt}

\newcounter{thefigs}
\newcommand{\fignum}{\arabic{thefigs}}

\newcounter{thetabs}
\newcommand{\tabnum}{\arabic{thetabs}}

\newcounter{address}

\slugcomment{To be submitted to \aj}

\shortauthors{Blanton {\it et al.} (2000)}
\shorttitle{$K$-corrections and filter transformations}

\begin{document}
 
\title{$K$-corrections and filter transformations \\
from the restframe
ultraviolet to the near infrared}

\author{
Michael R. Blanton\altaffilmark{\ref{NYU}} and 
Samuel Roweis
%Tamas Budavari\altaffilmark{\ref{JHU}},
%Andrew J. Connolly\altaffilmark{\ref{Pitt}},
%J.~Brinkmann\altaffilmark{\ref{APO}},
%Istv\'an Csabai\altaffilmark{\ref{JHU}},
%Mamoru Doi\altaffilmark{\ref{Tokyo}},
%Daniel Eisenstein\altaffilmark{\ref{Arizona}},
%Masataka Fukugita\altaffilmark{\ref{CosmicRay},\ref{IAS}},
%James E. Gunn\altaffilmark{\ref{Princeton}},
%David W. Hogg\altaffilmark{\ref{NYU}}, and
%David J. Schlegel\altaffilmark{\ref{Princeton}}
%Julianne Dalcanton\altaffilmark{\ref{UW}},
%Jon Loveday\altaffilmark{\ref{Sussex}},
%Michael A. Strauss\altaffilmark{\ref{Princeton}},
%Mark SubbaRao\altaffilmark{\ref{Chicago}},
%David H. Weinberg\altaffilmark{\ref{Ohio}},
%John E. Anderson, Jr.\altaffilmark{\ref{Fermilab}},
%James Annis\altaffilmark{\ref{Fermilab}},
%Neta A. Bahcall\altaffilmark{\ref{Princeton}},
%Mariangela Bernardi\altaffilmark{\ref{Chicago}},
%Robert J. Brunner\altaffilmark{\ref{Caltech}},
%Scott Burles\altaffilmark{\ref{Fermilab}},
%Larry Carey\altaffilmark{\ref{UW}},
%Francisco J. Castander\altaffilmark{\ref{Chicago}, \ref{Pyrenees}},
%Andrew J. Connolly\altaffilmark{\ref{Pitt}},
%Istv\'an Csabai\altaffilmark{\ref{JHU}},
%Douglas Finkbeiner\altaffilmark{\ref{Berkeley}},
%Scott Friedman\altaffilmark{\ref{JHU}},
%Joshua A. Frieman\altaffilmark{\ref{Fermilab}},
%G. S. Hennessy\altaffilmark{\ref{USNO}},
%Robert B. Hindsley\altaffilmark{\ref{USNO}},
%Takashi Ichikawa\altaffilmark{\ref{Tokyo}},
%\v{Z}eljko Ivezi\'{c}\altaffilmark{\ref{Princeton}},
%Stephen Kent\altaffilmark{\ref{Fermilab}},
%G. R.~Knapp\altaffilmark{\ref{Princeton}},
%D. Q.~Lamb\altaffilmark{\ref{Chicago}},
%R. French Leger\altaffilmark{\ref{UW}},
%Daniel C. Long\altaffilmark{\ref{APO}},
%Robert H. Lupton\altaffilmark{\ref{Princeton}},
%Timothy A.~McKay\altaffilmark{\ref{Michigan}},
%Avery Meiksin\altaffilmark{\ref{Edinburgh}},
%Aronne Merelli\altaffilmark{\ref{Caltech}},
%Jeffrey A. Munn\altaffilmark{\ref{USNO}},
%Vijay Narayanan\altaffilmark{\ref{Princeton}},
%Matt Newcomb\altaffilmark{\ref{CarnegieMellon}},
%R. C. Nichol\altaffilmark{\ref{CarnegieMellon}},
%Sadanori Okamura\altaffilmark{\ref{Tokyo}},
%Russell Owen\altaffilmark{\ref{UW}},
%Jeffrey R.~Pier\altaffilmark{\ref{USNO}},
%Adrian Pope\altaffilmark{\ref{JHU}},
%Marc Postman\altaffilmark{\ref{STScI}},
%Thomas Quinn\altaffilmark{\ref{UW}},
%Constance M. Rockosi\altaffilmark{\ref{Chicago}},
%Donald P. Schneider\altaffilmark{\ref{PennState}}, 
%Kazuhiro Shimasaku\altaffilmark{\ref{Tokyo}},
%Walter A. Siegmund\altaffilmark{\ref{UW}},
%Stephen Smee\altaffilmark{\ref{Maryland}},
%Yehuda Snir\altaffilmark{\ref{CarnegieMellon}},
%Chris Stoughton\altaffilmark{\ref{Fermilab}},
%Christopher Stubbs\altaffilmark{\ref{UW}},
%Alexander S.~Szalay\altaffilmark{\ref{JHU}},
%Gyula P.~Szokoly\altaffilmark{\ref{Potsdam}},
%Aniruddha R.~Thakar\altaffilmark{\ref{JHU}},
%Christy Tremonti\altaffilmark{\ref{JHU}},
%Douglas L. Tucker\altaffilmark{\ref{Fermilab}},
%Alan Uomoto\altaffilmark{\ref{JHU}},
%Dan vanden Berk\altaffilmark{\ref{Fermilab}},
%Michael S. Vogeley\altaffilmark{\ref{Drexel}},
%Patrick Waddell\altaffilmark{\ref{UW}},
%Brian Yanny\altaffilmark{\ref{Fermilab}},
%Naoki Yasuda\altaffilmark{\ref{NAOJ}},
%and Donald G.~York\altaffilmark{\ref{Chicago}}
}

\altaffiltext{1}{Based on observations obtained with the
Sloan Digital Sky Survey} 
\setcounter{address}{2}
\altaffiltext{\theaddress}{
\stepcounter{address}
New York University, Department of Physics, 4 Washington Place, New
York, NY 10003
\label{NYU}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Department of Physics and Astronomy, The Johns Hopkins University,
%Baltimore, MD 21218
%\label{JHU}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%University of Pittsburgh,
%Department of Physics and Astronomy,
%3941 O'Hara Street,
%Pittsburgh, PA 15260
%\label{Pitt}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Department of Astronomy and Research Center for 
%the Early Universe,
%School of Science, University of Tokyo,
%Tokyo 113-0033, Japan
%\label{Tokyo}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Steward Observatory, 
%933 N. Cherry Ave., Tucson, AZ
%85721
%\label{Arizona}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Princeton University Observatory, Princeton,
%NJ 08544
%\label{Princeton}}
%\addtocounter{address}{1}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Fermi National Accelerator Laboratory, P.O. Box 500,
%Batavia, IL 60510
%\label{Fermilab}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Department of Astronomy, University of Washington,
%Box 351580,
%Seattle, WA 98195 
%\label{UW}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%University of Chicago, Astronomy \&
%Astrophysics Center, 5640 S. Ellis Ave., Chicago, IL 60637
%\label{Chicago}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Hubble Fellow 
%\label{Hubble}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Sussex Astronomy Centre,
%University of Sussex,
%Falmer, Brighton BN1 9QJ, UK
%\label{Sussex}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Ohio State University,
%Department of Astronomy,
%Columbus, OH 43210
%\label{Ohio}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Apache Point Observatory,
%2001 Apache Point Road,
%P.O. Box 59, Sunspot, NM 88349-0059
%\label{APO}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Department of Astronomy, California Institute of Technology,
%Pasadena, CA 91125
%\label{Caltech}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Observatoire Midi-Pyr\'en\'ees, 
%14 ave Edouard Belin, Toulouse, F-31400, France
%\label{Pyrenees}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%UC Berkeley, Dept. of Astronomy, 601 Campbell Hall, Berkeley, CA  94720-3411
%\label{Berkeley}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Institute for Cosmic Ray Research, University of
%Tokyo, Midori, Tanashi, Tokyo 188-8502, Japan
%\label{CosmicRay}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Institute for Advanced Study, Olden Lane,
%Princeton, NJ 08540
%\label{IAS}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%U.S. Naval Observatory,
%3450 Massachusetts Ave., NW,
%Washington, DC  20392-5420
%\label{USNO}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%University of Michigan, Department of Physics,
%500 East University, Ann Arbor, MI 48109
%\label{Michigan}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Department of Physics \& Astronomy,
%The University of Edinburgh,
%James Clerk Maxwell Building,
%The King's Buildings,
%Mayfield Road,
%Edinburgh EH9 3JZ, UK
%\label{Edinburgh}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Department of Physics, Carnegie Mellon University, 
%5000 Forbes Avenue, Pittsburgh, PA 15213-3890 
%\label{CarnegieMellon}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Space Telescope Science Institute, Baltimore, MD 21218
%\label{STScI}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Department of Astronomy and Astrophysics,
%The Pennsylvania State University,
%University Park, PA 16802
%\label{PennState}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Department of Astronomy,
%University of Maryland,
%College Park, MD 20742-2421 
%\label{Maryland}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Astrophysikalisches Institut Potsdam,
%An der Sternwarte 16, D-14482 Potsdam, Germany
%\label{Potsdam}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%Department of Physics, Drexel University, Philadelphia, PA 19104
%\label{Drexel}}
%\altaffiltext{\theaddress}{
%\stepcounter{address}
%National Astronomical Observatory, Mitaka, Tokyo 181-8588, Japan
%\label{NAOJ}}
%\addtocounter{address}{1}
%\altaffiltext{\theaddress}{Physics Dept., University of California, Davis, CA 95616
%\label{UCDavis}}
%\addtocounter{address}{1}
%\altaffiltext{\theaddress}{IGPP/Lawrence Livermore National Laboratory
%\label{IGPP}}
%\addtocounter{address}{1}
%\altaffiltext{\theaddress}{Department of Astronomy, University of California, Berkeley, C
%A 94720-3411
%\label{Berkeley}}
%\stepcounter{address}
%\altaffiltext{\theaddress}{Remote Sensing Division, Code 7215, Naval
%Research Laboratory, Washington, DC 20375
%\label{NRL}}
%\addtocounter{address}{1}
%\altaffiltext{\theaddress}{U.S. Naval Observatory, Flagstaff Station,
%P.O. Box 1149,
%Flagstaff, AZ  86002-1149
%\label{Flagstaff}}

\clearpage

\begin{abstract}
We present a method of developing model-based spectroscopic templates
to explain observed galaxy fluxes. Such templates are useful for
calculating $K$-corrections, calculating photometric redshifts, and
converting among observations of galaxies at various wavelengths. In
principle, we could apply this method to galaxy data at any redshift
and in any set of wavelengths. The implementation we present here is
suitable for ultraviolet, optical, and near-infrared
observations. Since we base the templates on stellar population
synthesis results, the results are intepretable in terms of
approximate stellar masses and star-formation histories. We present
templates fit with this method to data from GALEX, Sloan Digital Sky
Survey spectroscopy and photometry, the Two-Micron All Sky Survey, the
Deep Extragalactic Evolutionary Probe and Great Observatories Origins
Deep Survey.  In addition, we present software for using such data to
estimate $K$-corrections, photometric redshifts, evolution
corrections, stellar masses, and recent star-formation rates. This
software is suitable for analyzing many other data sets as well.
\end{abstract}code

\keywords{galaxies: fundamental parameters --- galaxies: photometry
--- galaxies: statistics}

\section{Motivation}
\label{motivation}

New surveys at a low and high redshift have provided us with estimates
of galaxy spectral energy distributions (SEDs) for an enormous number
of galaxies. When comparing populations of galaxies at different
redshifts in these surveys, we need to use comparable measurements of
the galaxy SEDs. However, different surveys use different bandpasses
and the restframe wavelengths of these bandpasses necessarily vary
with redshift. We need to be able to handle this heterogeneity in
order to make sensible comparisons among all of these new surveys.

In this paper, we present a method for doing so, by calculating
$K$-corrections between observed and desired bandpasses.  The
$K$-correction between a bandpass $R$ used to observe a galaxy at
redshift $z$ and the desired bandpass $Q$ is defined by the equation
(\cite{oke68a, hogg02a}):
\begin{equation}
\label{kcorrecteqn}
m_R = M_Q + \mathrm{DM}(z) + K_{QR}(z) - 5 \log_10 h 
\end{equation}
where $\mathrm{DM}(z) = 25 - 5\log_{10} (d_L / (h^{-1}{\mathrm{~Mpc}}))$ is the
bolometric distance modulus calculated from the luminosity distance
$d_L$, and $M_Q$ is the absolute magnitude. The absolute magnitude is
defined as the apparent magnitude an object would have if were
observed 10 pc away, in bandpass $Q$, at rest.  The traditional
definition of the $K$-correction takes $Q=R$. however, we note that in
practice many surveys do perform $K$-corrections from one observed
bandpass $R$ to another bandpass $Q$ in the rest frame. This practice
is particularly common when dealing with high redshift observations.
In addition to $K$-corrections, this method also provides an
interpretation of the data in terms of a physical model which
describes the stellar mass and star-formation history of each galaxy.

The templates are designed to work well for a wide range of data sets.
We constrain them with photometry and spectroscopy of the Sloan
Digital Sky Survey (SDSS; \citealt{york00a}) the Galaxy Evolution
Explorer (GALEX; {\bf ref})) in the ultraviolet, and the Two-Micron
All Sky Survey (2MASS; \citealt{strutskie97a}) in the near infrared
(NIR). In addition, at higher redshifts, we use constraints from the
Deep Extragalactic Evolutionary Probe 2 (DEEP2; {\bf ref} and the
Great Observatories Origins Deep Survey (GOODS; {\bf ref}).  These and
other data sets provide a huge set of information about galaxy colors
and spectra which we can use to help understand their star-formation
histories. 

We note that the methods used here are generally useful. Using these
methods to develop templates has the advantage that one can easily
search a large space of models in order to find the few templates
necessary in order to explain a given set of data.

We also release the templates in electronic form as well as an
implementation of the methods used to fit the templates to data. This
software {\tt kcorrect v4\_1} is distributed on the World Wide
Web{\footnote {\tt http://cosmo.nyu.edu/blanton/kcorrect/}}. It
consists of a core C library which performs most of the complex and
computationally intensive tasks, plus an IDL library that provides a
high-level interface.  This software is an update of two major earlier
releases ({\tt v1\_16}, \citet{blanton03b}; {\tt v3\_2}). The
improvement over the latest version is twofold. First, we have
improved the templates such that they successfully fit galaxies in the
restframe UV, as observed by GALEX, DEEP2, and GOODS. Second, because
the templates are now completely model-based, the fits have a physical
interpretation in terms of a star-formation history. The IDL library
also has a number of new useful functions.

\section{Finding the templates}
\label{algorithm}

\subsection{Overview}

From the spectroscopic observations we know that galaxy spectra reside
in a low-dimensional locus. Principal Component Analysis (PCA) of
galaxy spectra, introduced by \citet{connolly94a} and applied many
times since then ({\bf more refs}; \citealt{yip05a}), demonstrates
that most of the variance in the distribution of galaxies in spectral
space can be explained using a few templates. This means that, in the
linear space of all possible spectra, galaxies exist in only a small
locus. Therefore, even with very heterogeneous data, we should be able
to determine the properties of this locus.

Here we present an approach to combining the heterogeneous data
described above in order to determine the properties of the locus of
galaxy spectra. Rather than taking the model-free approach used by
PCA, we here restrict the space of possible spectra to those predicted
from the high resolution stellar population synthesis model of
\citet{bruzual03a} and the emission line models of {\bf mappings
ref}.  This approach both constrains the problem appropriately and
yields a natural theoretical interpretation of the results in terms of
star-formation histories.

In a nutshell, our algorithm does the following. Given the
observations (and uncertainties of those observations) available for
each galaxy, it finds the nonnegative linear combination of $N$
template star-formation histories which best predict those
observations in the $\chi^2$ sense. Given the entire set of galaxy
observations available, it also fits for those template star-formation
histories. The technical name for this algorithm is Nonnegative Matrix
Factorization (NMF).

This approach is similar to PCA in that it finds the small spectral
subspace in which galaxies exist, and can in some ways be thought of
as ``nonnegative PCA.''  However, our method has several advantages
over the standard PCA approach. First, it has a natural physical
interpretation associated with that spectral subspace, which is the
corresponding subspace of all possible star-formation
histories. Second, it naturally handles data uncertainties and missing
data, which allows it to ignore that variation which is due purely to
statistical errors.  Third, it handles the complications of observing
galaxy spectra photometrically using broad-band filters.

In this section, we describe how to take the astrophysical
models and the astronomical observations, and to pose the problem in
the form needed for the purposes of NMF. In the Appendix we describe
how to solve to NMF problem.

\subsection{The models}

We begin with a basis set of 485 spectral templates. Of these, 450 are
a set of instantaneous bursts from \citet{bruzual03a}. There are 6
metallicities (0.005, 0.02, 0.2, 0.4, 1, and 2.5 times solar). For
each metallicity there are 25 ages (between 1 Myr and 13.75 Gyr,
spaced almost logarithmically in age).  For each age and metallicity
there are 3 choices of dust model: (1) no dust extinction; (2) $\tau_V
= 3$ dust with Milky Way type extinction (as input into the models of
\citealt{witt00a} with a ``homogeneous'' distribution and ``shell''
geometry); (3) $\tau_V = 3$ dust with SMC type extinction (from the
same models). We smooth each template to $300$ km s$^{-1}$ velocity
dispersion. 

The remaining 35 templates are from MAPPINGS-III {\bf ref} models of
emission from ionized gas. We choose the predictions for an 8 Myr old
continuous star-formation history with 5 possible metalliciticites
(0.5, 0.2, 0.4, 1.0, and 2. times solar) and 7 possible ionization
parameters ($q= 5\times 10^6$, $10^7$, $2\times 10^7$, $4\times 10^7$,
$8 \times 10^7$, $1.5\times 10^8$, and $3\times 10^8$ cm s$^{-1}$). We
take the spectra (given as a set of delta functions) and smooth them
to $300$ km s$^{-1}$ velocity dispersion.

Let us refer to these 485 basis templates as $M_{\lambda,
j}(\lambda)$, expressed in units of ergs s$^{-1}$ \AA$^{-1}$.

We seek five templates $F_{\lambda, i}(\lambda)$ which are built from
nonnegative combinations of the original basis set of $N$ templates:
\begin{equation}
F_{\lambda, i}(\lambda) = \sum_j b_{ij} M_{\lambda, j}(\lambda),
\end{equation}
in units of ergs s$^{-1}$ \AA$^{-1}$.  For each galaxy $k$
we want our model ${\hat{F}_\lambda}(\lambda)$ for their spectrum to
be a nonegative sum of these five templates:
\begin{equation}
{\hat{F}}_{\lambda,_k}(\lambda) = \sum_i a_{ki} F_{\lambda,i}(\lambda).
\end{equation}

\subsection{The data}

The training set consists of:
\begin{enumerate}
\item SDSS spectroscopic data in the observed range $3800 < \lambda <
9000$ \AA, for 400 Luminous Red Galaxies between $0.15 < z < 0.5$ (LRGs;
\citealt{eisenstein02a}) and 1600 Main sample galaxies between $0.001
< z < 0.4$ (\citealt{strauss02a})
\item SDSS photometric data on an independent set of LRGs ($griz$
photometry only) and Main sample galaxies (using the full $ugriz$
photometry). We use 2000 LRGs and 7000 Main sample galaxies.  For
these galaxies we include 2MASS $JHK_s$ data ({\bf ref}) where
available.
\item GALEX DR1 far UV ($\sim 1500$ \AA) and near UV ($\sim 2300$ \AA)
photometry for objects with SDSS redshifts and $ugriz$ photometry (4000
galaxies; {\bf ref}).
\item The $BRI$ photometry for high redshift galaxies in the DEEP2 
DR1 release between $0.6 < z < 1.5$ (4000
galaxies; {\bf ref}).
\item The $BVizJHK_s$ photometry for GOODS galaxies between $0.5 < z < 2$ (1000
galaxies; {\bf ref}).
\end{enumerate}
The SDSS, 2MASS, and GALEX galaxies were selected from and the matches
were obtained by the New York University Value-Added Galaxy Catalog
(NYU-VAGC;
\citealt{blanton05b}).  

The SDSS data processing consists of astrometry \citep{pier03a};
source identification, deblending and photometry \citep{lupton01a};
photometricity determination \citep{hogg01a}; calibration
\citep{fukugita96a,smith02a}; spectroscopic target selection
\citep{eisenstein01a,strauss02a,richards02a}; spectroscopic fiber
placement \citep{blanton03a}; and spectroscopic data reduction.  We
recalibrated our photometry using the ``ubercalibration'' procedure
described in \citet{blanton05b}.  Descriptions of these pipelines also
exist in \citet{stoughton02a}.  An automated pipeline called {\tt
idlspec2d} (in this case {\tt v4\_9}) measures the redshifts and
classifies the reduced spectra (Schlegel et al., in preparation).

Note that there are 20 different broadband photometric filters listed
above ($B$ in DEEP2 is different than the $B$ used by GOODS). The {\tt
kcorrect} product described in Section \ref{code} contains a
tabulation of the response functions for all of these filters.

\subsection{Comparing data and models}

The data consist of spectra and bandband photometric measurements of
galaxies at a number of redshifts, and we have to relate the models to
these measurements.

For the spectra, we take the observed spectrum
$f_{\lambda,k}(\lambda)$ (in ergs cm$^{-2}$ s$^{-1}$ \AA$^{-1}$) of
each galaxy $k$ at redshift $z$ (corresponding to a luminosity
distance $d_L(z)$ in cm; see \citealt{hogg99a}) and calculate the
restframe luminosity per unit wavelength:
\begin{equation}
{{F}}_{\lambda, k}(\lambda) = 
{{f}}_{\lambda, k}[\lambda (1+z)](1+z) (4 \pi d_L^2),
\end{equation}
That is, the spectrum is shifted due to the redshift, while the
integral of the numerator over wavelength (the total luminosity) is
constant with redshift, and the total flux is related to the total
luminosity by the inverse square law.  In addition, we smooth each
spectrum by such an amount that, given its estimated velocity
dispersion, its total velocity dispserion after smoothing is 300 km
s$^{-1}$.

Note that if we discretize the spectra to wavelengths $\lambda_l$, the
relationship between the predicted SED for a galaxy $k$ and the basis
set $M_{jl}$, becomes simply:
\begin{equation}
\hat{F}_{kl} = \sum_{ij} a_{ki} b_{ij} M_{jl}
\end{equation}

If one has a spectrum for a galaxy the
expression for the contribution to $\chi^2$ from each wavelength
$\lambda_l$ in the spectrum is then quite simple:
\begin{eqnarray}
\label{chi2spec}
\chi_{kl}^2 &=& \left[\frac{F_{\lambda,k}(\lambda_l) -
{\hat{F}}_{\lambda,k}(\lambda_l)} 
{\sigma^2_k(\lambda_l)}\right]^2 \cr
&=&
\left[\frac{F_{\lambda,k}(\lambda_l) -
\sum_{ij} a_{ki} b_{ij} M_{jl}
}{\sigma^2_k(\lambda_l)}\right]^2. 
\end{eqnarray}

Comparing observed broadband flux measurements is a bit more
complicated, because it is a projection of the spectrum onto the
broadband filter $p$ at the observed redshift $z$. Instead of
adjusting the observed fluxes as we could so easily do for the spectra
above, for the photometry we express the models in terms of predicted
broadband fluxes.

Here we express the flux for each galaxy $k$ in units of AB maggies
$\mu_p$, which are defined as what one would measure in bandpass $p$
relative to the AB standard source. For example, if we transform our
spectral energy density basis function $M_{\lambda, j}(\lambda)$ to a flux
density $m_{\lambda, j}(\lambda)$, we can calculate the contribution of
that basis function to the predicted maggies as:
\begin{equation}
\label{maggies}
\eta_{jp} = 
\frac{\int_0^{\infty} d\lambda \lambda R_p(\lambda) {m}_{\lambda, j}(\lambda)}
{\int_0^\infty d\lambda \lambda R_p(\lambda) f_{\lambda,
\mathrm{AB}}(\lambda) }
\end{equation}
Here, the response function $R_p(\lambda)$ is proportional to the
contribution to the detector signal of a photon with wavelength
$\lambda$ entering the Earth's atmosphere (or entering the telescope
for a space telescope). The AB standard source is $f_{\lambda,
\mathrm{AB}}(\lambda) d\lambda = f_{\nu,
\mathrm{AB}} (\nu) d\nu$ and $f_{\nu, \mathrm{AB}}=3631$ Jy $= 3.631 \times
10^{-20}$ erg s$^{-1}$ cm$^{-2}$ Hz$^{-1}$. Of course maggies $\mu$
are related to magnitudes $m$ as:
\begin{equation}
m = -2.5 \log_{10} \mu, 
\end{equation}
such that the AB standard source would (if it existed) have $\mu=1$
and $m=0$ for all bandpasses.

In this context it is worth noting that many authors
(e.g. \citealt{bessell90a}) tabulate the contribution to the detector
signal per {\it unit of energy} in photons of wavelength $\lambda$
instead of per {\it photon} with wavelength $\lambda$.  We will refer here
to that quantity as $R_p'(\lambda)$, though in the literature it is
often referred to without a prime (and without any explicit
definition!). Clearly $R_p(\lambda) \propto R_p'(\lambda)/\lambda$,
since the higher the frequency of the photon, at a fixed response per
unit energy there is a higher response per photon. With this
substitution, one can reexpress Equation
\ref{maggies} appropriately in terms of $R_p'(\lambda)$.  
Generally, though not universally, authors tabulate $R_p'(\lambda)$
for bandpasses whose standards were originally calibrated using
energy-counting devices rather than photon-counting devices. However,
from the point of view of the analysis of the observations it is
irrelevant what the devices used for the standards and the
observations are, as long as one calculates $R_p(\lambda)$ and uses
Equation \ref{maggies}.  

The prediction for the broadband fluxes from Equation
\ref{maggies} is only for a specific redshift $z$. It turns out to
simplify our mathematics to calculate the projection of each basis
function $j$ onto each filter $p$ for a grid of redshifts (in this
case spaced by 0.005 between redshifts 0 and 2). Thus, below we will
take $p$ to index all the filters at all such redshifts.

Just as before, we can now write down the relationship between the
predicted broadband flux and the basis set $\mu_{jp}$, in the bandpass
and redshift corresponding to the index $p$, for a galaxy $k$:
\begin{equation}
\hat{\mu}_{kp} = \sum_{ij} a_{ki} b_{ij} \eta_{jp}
\end{equation}

The contribution to the total $\chi^2$ of a broadband flux is
therefore just:
\begin{eqnarray}
\label{chi2photo}
\chi^2_{kp} &=& \left[\frac{\mu_{kp} - \hat\mu_{kp}}
{\sigma_{kp}}\right]^2 \cr
&=&
\left[\frac{\mu_{kp} -
\sum_{ij} a_{ki} b_{ij} \eta_{jp}
}{\sigma^2_{kp}}\right]^2. 
\end{eqnarray}
For a given galaxy we do not have every filter, and we only have an
observation of each filter at a single redshift. We pick the closest
redshift on the redshift grid, and use the measured filters at that
redshift for our expression of $\chi^2$, and set $1/\sigma_{kp}^2 = 0$
for the rest of the values of the index $p$ so that we zero-weight
those predictions.

$\eta_{jp}$ and $M_{jl}$ are totally fixed, and we combine them into a
single matrix $M_{jn}$ and the indices $p$ and $l$ into a single index
$n$. We can similarly combine our observations $\mu_{kp}$ and
$F_{\lambda, k}(\lambda_l)$ and their uncertainties $\sigma_{kp}$ and 
$\sigma_{k}(\lambda_l)$ into vectors $x_{kn}$ and $\sigma_{kn}$.
Then we can combine the Equations \ref{chi2spec} and \ref{chi2photo}
into a single equation:
\begin{equation}
\label{chi2}
\chi^2 = \sum_{kn} \left[ 
\frac{x_{kn} - \sum_{ij} a_{ki} b_{ij} M_{jn}}
{\sigma_{kn}} \right]^2
\end{equation}
There is a simple method that we describe in the Appendix called
nonnegative matrix factorization (NMF) to iterate to the nonnegative
$a_{ki}$ and $b_{ij}$ which minimize Equation \ref{chi2}. The basic
method is implemented in a public piece of code named {\tt
NMF\_SPARSE} in the {\tt idlutils} distribution of IDL
utilities.\footnote{\tt http://skymaps.info}. As the name implies, our
implementation takes advantage of the fact that many of the matrix
operations are on very sparse matrices (for example, for each galaxy
with photometric data there are {\it no} spectroscopic data points and
{\it only} photometric data at a single redshift).

Once we have fit for $b_{ij}$ using the training set, we can minimize
Equation \ref{chi2} for any other galaxy using any nonnegative least
squares algorithm (since the minimization of Equation \ref{chi2} has a
linear form in that case).  When we do so here we use the beautifully
simple iterative method of \citet{sha02a}.

\section{Results}

\subsection{An example: the Luminous Red Galaxy templates}

We begin with the simplest case, which is fitting a {\it single}
template to the photometric data of the LRG sample
(\citealt{eisenstein02a}). For many of these galaxies, which extend to
$r<19.5$ and are intrinsically red, the $u$-band flux is extremely
poorly measured, so we ignore the $u$-band for all LRGs. 

Figure \ref{spec_lrg} shows the spectrum of the best-fit LRG.  This
template is constrained by data between about 2000 and 10000 \AA;
outside that range it is an extrapolation. 

Figure \ref{sfh_lrg} shows the star-formation history corresponding to
this best-fit LRG spectrum. The top panel shows the star-formation per
unit time as a function of look-back time.  The thick, straight

Figure \ref{lrg_colors} shows the LRG colors as a function of
redshift, with the best fit template color overplotted as the smooth,
thick line. Thus, the best fit is a good fit to the data

Note that in this example we have fit a nonevolving template, which is
inappropriate over this range of redshifts --- even if it is a good
fit to the colors! In principle, we can adjust the methods used here
for the case of evolving templates, but we will not do so here.

\subsection{Description of the templates}

Figure \ref{spec_templates} shows the spectrum from the ultraviolet
through the near infrared for the resulting templates. Note that there
is a very old template, a very young template, and several
intermediate templates, including one which is close to that of an A
star. 

Figure \ref{sfh_templates} shows the star-formation histories and
metallicities associated with the templates. We have not imposed any
smoothness criterion on these fits, which explains the ragged
appearance of these histories. We do not believe the details of these
fits, since neighboring ages or metallicities are highly degenerate
with one another.

{\bf how are numbers released}

\subsection{Explanatory power of templates}

These templates explain the photometric data rather well. 
[SDSS]

[SDSS + 2MASS] 

[SDSS + GALEX] 

[DEEP2]

[GOODS]

In addition, they provide fairly good fits to the SDSS spectroscopic
data. However, in detail they do not fit the SDSS data.

\subsection{Predictive power of templates}

[2MASS] 

[GALEX] 

[ H alpha color relationship ]

\section{Determining $K$-corrections}
\label{kcorrect}

Given a model spectrum for the galaxy, the determination of the
$K$-correction is straightforward. Here we repeat the 

[ Figure demonstrate K-corrections ]

[ Figure show K-corrections to z=0 ]

[ note band-shifting ]

[ Figure test: against projection of a bunch of spectra ]

\section{Physical interpretation of the models}

[ solar magnitudes ]

[ Figure mass-to-light ratio ]

[ Figure recent SF ]

\section{Linear relationships between common magnitude systems}

[ vega to ab ]

[ conversions ]

\section{Public access to the code}
\label{code}

\section{Summary}
\label{conclusions}

[ summarize ]

[ this does not describe what constraints photometry puts on the SFH ]

\acknowledgments

This publication makes use of data products from the Two Micron All
Sky Survey, which is a joint project of the University of
Massachusetts and the Infrared Processing and Analysis
Center/California Institute of Technology, funded by the National
Aeronautics and Space Administration and the National Science
Foundation.

The Galaxy Evolution Explorer (GALEX) is a NASA Small Explorer. The
mission was developed in cooperation with the Centre National d'Etudes
Spatiales of France and the Korean Ministry of Science and Technology.

DEEP2 is a collaboration between UC Santa Cruz and UC Berkeley.
Funding for the DEEP2 survey has been provided by NSF grant
AST-0071048 and AST-0071198.

Funding for the creation and distribution of the SDSS Archive has been
provided by the Alfred P. Sloan Foundation, the Participating
Institutions, the National Aeronautics and Space Administration, the
National Science Foundation, the U.S. Department of Energy, the
Japanese Monbukagakusho, and the Max Planck Society. The SDSS Web site
is {\tt http://www.sdss.org/}.

The SDSS is managed by the Astrophysical Research Consortium (ARC) for
the Participating Institutions. The Participating Institutions are The
University of Chicago, Fermilab, the Institute for Advanced Study, the
Japan Participation Group, The Johns Hopkins University, Los Alamos
National Laboratory, the Max-Planck-Institute for Astronomy (MPIA),
the Max-Planck-Institute for Astrophysics (MPA), New Mexico State
University, Princeton University, the United States Naval Observatory,
and the University of Washington.
 
\bibliographystyle{../../../nyu-astro/tex/apj}
\bibliography{../../../nyu-astro/tex/apj-jour,../../../nyu-astro/tex/ccpp}

\appendix

\section{Nonnegative matrix factorization (NMF)}

\section{$K$-corrections to Shifted bandpasses}

{\bf NMF}

\newpage

%\include{tables}

\include{kcorrect_figures}

\end{document}
